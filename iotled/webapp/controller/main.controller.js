sap.ui.define([
	"sap/ui/core/mvc/Controller",
	"vspiotled/utils/IOT",
	"sap/m/MessageToast",
	"sap/ui/model/Sorter"
], function(Controller, IOT, MessageToast, Sorter) {
	"use strict";
	
	return Controller.extend("vspiotled.controller.main", {
		onInit: function() {

		},
		/**
		 * Called when the View has been rendered (so its HTML is part of the document). 
		 * Post-rendering manipulations of the HTML could be done here.
		 * This hook is the same one that SAPUI5 controls get after being rendered.
		 * @memberOf ui5lifecycledemo.main
		 */
		onAfterRendering: function(oEvent) {
			},
		/**
		 *@memberOf vspiotled.controller.main
		 */
		onSwitch: function(oEvent) {
			//This code was generated by the layout editor.
			MessageToast.show("HelloAjax!");
			//console.log();
			//var sDeviceId = "1ac8a403-d4ec-4279-a31e-985127275d8b";
			var sDeviceId = "17a0ae42-ef16-433a-854c-7d38d1ee4f0a";
			//var sMessageTypeId = "91d1662d282a6b431c37";
			var sMessageTypeId = "753dfe8f3261014c6d41";
			var seconds = new Date().getTime();
			var message = [{
				"timestamp": parseInt(seconds / 1000),
				"Censor1": "led",
				"Censor2": oEvent.getSource().getState()
			}];
			IOT.pushData(sDeviceId, "http", "My IOT UI5", sMessageTypeId, message, function(result) {
				MessageToast.show("Message send!");
			}, function(error) {
				MessageToast.show("Message error!" + error.responseText);
			});
		},

		onUpdateDone: function(oEvent) {
			//	alert("update done");
			var state = this.getModel().getObject(this.getView().byId("table").getItems()[0].getBindingContext().getPath(), this.getView().byId(
				"table").getItems()[0].getBindingContext());
			this.getView().byId("txtCapsLock").setText(state.C_LEDSTATE);
			this.getView().byId("txtTimeStamp").setText(state.C_TIMESTAMP);
			this.getView().byId("__switch0").setState(state.C_LEDSTATE);
		},

		/**
		 *@memberOf vspiotled.controller.main
		 */
		onPress: function(oEvent) {
			var laSorters = new Array();
			var sort = new sap.ui.model.Sorter("C_TIMESTAMP", true);
			laSorters.push(sort);
			var urlParams = "$top=1";
			var allthis = this;
			/*			var readData = this.getModel().read("/T_IOT_9658E7591BA1F6500040",{sorters: laSorters,urlParameters:urlParams, success: function(oData,Response){
							console.log(oData);
							console.log(allthis.getModel());
						}, error: function(error){
							console.log(error);
						}});
						console.log(readData);
						*/
			this.getView().byId("table").unbindItems();
			var oTemplate = new sap.m.ColumnListItem({
				cells: [
					new sap.m.Text({
						text: "{C_TIMESTAMP}"
					}),
					new sap.m.Text({
						text: "{C_LEDSTATE}"
					})
				]
			});



			this.getView().byId("table").bindItems({
				path: "/T_IOT_9658E7591BA1F6500040",
				length: "1",
				template: oTemplate,
				sorter: sort,
				parameters: urlParams
			});

			//this.getModel().refresh(false, false);
			//	this.getView().byId("table").setSelectedItem("1",true);

			//	console.log(this.getView().byId("table").getItems()[0].getBindingContext());
			//	console.log(this.getModel().getKey(this.getView().byId("table").getItems()[0].getBindingContext().getPath()));

			//var oModel = this.getModel();

			var interval = setInterval(function() {
				allthis.getView().byId("table").bindItems({
					path: "/T_IOT_9658E7591BA1F6500040",
					length: "1",
					template: oTemplate,
					sorter: sort,
					parameters: urlParams
				});
				allthis.getModel().refresh(true,true);
			}, 1000);
		},

		getModel: function(sName) {
			return this.getView().getModel(sName);
		},
		setModel: function(oModel, sName) {
			return this.getView().setModel(oModel, sName);
		},
		/**
		 *@memberOf vspiotled.controller.main
		 */
		onModelChange: function() {
			//This code was generated by the layout editor.
			//	alert("hello");
		}
	});
});